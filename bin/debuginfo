#!/usr/bin/env bash

targets=()
src=0

while [[ $# -gt 0 ]]; do
    if [[ $1 == --src ]]; then
        src=1
        shift
        continue
    fi
    if [[ $1 != /* ]]; then
        targets+=("$(command -v "$1")")
    else
        targets+=("$1")
    fi
    shift
done

drv=$(nix derivation show -- "${targets[@]}")
if [[ $src == 0 ]]; then
    debuginfo_out=$(echo "$drv" | jq -r 'to_entries | .[] | .value.outputs.debug.path | select(. != null) | (. + "/lib/debug")')
    echo "$debuginfo_out" | xargs -- nix-store --quiet --quiet --quiet -r > /dev/null
    echo -n "$debuginfo_out" | tr '\n' ':'
else
    echo "$drv" | jq -r 'to_entries | .[] | .value.env.src'
fi
