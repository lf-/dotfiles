name: Copybara
on:
  push:
    branches:
      - main

jobs:
  copybara:
    name: Copybara
    runs-on: ubuntu-latest
    steps:
      - name: Set up GitHub app creds
        id: get-github-token
        uses: getsentry/action-github-app-token@d4b5da6c5e37703f8c3b3e43abb5705b46e159cc # v3
        with:
          app_id: ${{ secrets.GH_APP_ID }}
          private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      # Quality Code taken from https://github.com/lilyinstarlight/foosteros/blob/bdfcbca5a0b0124f8519b57217891efb6508f124/.github/workflows/checks.yml
      - uses: DeterminateSystems/nix-installer-action@v16
        with:
          diagnostic-endpoint: ''
          source-url: '${{ inputs.nix_installer || format(''https://install.lix.systems/lix/lix-installer-{0}-{1}'', fromJSON(''{"X64":"x86_64","X86":"i686","ARM64":"aarch64","ARM":"armv7l"}'')[runner.arch], fromJSON(''{"Linux":"linux","macOS":"darwin","Windows":"windows"}'')[runner.os]) }}'

      - uses: actions/checkout@v4
        with:
          token: ${{ steps.get-github-token.outputs.token }}

      # of course actions/checkout does this for you but only locally for the
      # single repo. that's unhelpful!
      - name: Set up token globally
        run: |
          # make sure that we are never set -x here
          set +x
          tok_b64=$(echo -n "x-access-token:${{ steps.get-github-token.outputs.token }}" | base64)
          # don't leak it!
          echo "::add-mask::$tok_b64"
          git config --global 'http.https://github.com/.extraheader' "AUTHORIZATION: basic ${tok_b64}"

      - name: git config
        run: |
          git config --global user.name 'jade.fyi copybara'
          git config --global user.email 'copybara@noreply.jade.fyi'

      - name: Run copybara
        run: |
          nix run ./configs/nix#pkgs.ci.copybara-workflow
